:- module(alloy2b_tests,[run_tests/0]).

:- use_module(alloy2b).
:- use_module(library(plunit)).

:- begin_tests(full_machine_translation).

test(cards,[]) :- 
    translate_model(alloy_model(facts([]),assertions([]),commands([]),functions([predicate('ThreeOfAKind_',[identifier('hand_',type(['Card_'],1),pos(20,3))],[field('hand_',setof(identifier('Card_',type(['Card_'],1),pos(5,1)),type(['Card_'],1),pos(26,3)),type(['Card_'],1),pos(20,3))],and([equal(card(join(identifier('hand_',type(['Card_'],1),pos(20,3)),identifier('suit_',type(['Card->this_''Suit_'],2),pos(11,1)),type(['Suit_'],1),pos(8,4)),type(['Int_'],1),pos(3,4)),integer(1,pos(14,4)),type([untyped],0),pos(13,4)), equal(card(identifier('hand_',type(['Card_'],1),pos(20,3)),type(['Int_'],1),pos(20,4)),integer(3,pos(26,4)),type([untyped],0),pos(25,4))],pos(16,4)),pos(1,3))]),signatures([signature('Card_',[field('suit_',oneof(identifier('Suit_',type(['Suit_'],1),pos(5,2)),type(['Suit_'],1),pos(16,1)),type(['Suit_'],1),pos(11,1))],[],[],pos(5,1)),signature('Suit_',[],[],[],pos(5,2))])),Translated) , ! , 
    Translated == machine(generated(none,abstract_machine(none,machine(none),machine_header(none,alloytranslation,[]),[definitions(none,[predicate_definition(none,'ThreeOfAKind_',[identifier(none,hand_)],conjunct(none,conjunct(none,equal(none,card(none,identifier(none,hand_)),integer(none,3)),equal(none,card(none,image(none,identifier(none,suit_),identifier(none,hand_))),integer(none,1))),member(none,identifier(none,hand_),identifier(none,'Card_'))))]),sets(none,[deferred_set(none,identifier(none,'Suit_')),deferred_set(none,identifier(none,'Card_'))]),properties(none,[conjunct(none,member(none,identifier(none,suit_),identifier(none,'Suit_')),equal(none,card(none,identifier(none,suit_)),integer(none,1)))])]))).

test(filesystem,[]) :- 
    translate_model(alloy_model(facts([fact(all(['d_', 'o_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(15,11)),type(['Dir_'],1),pos(12,11)), field('o_',oneof(join(identifier('d_',type(['Dir_'],1),pos(12,11)),identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['FSObject_'],1),pos(24,11)),type(['FSObject_'],1),pos(23,11)),type(['FSObject_'],1),pos(20,11))],equal(join(identifier('o_',type(['FSObject_'],1),pos(20,11)),identifier('parent_',type(['FSObject->this_''Dir_'],2),pos(16,2)),type(['Dir_'],1),pos(37,11)),identifier('d_',type(['Dir_'],1),pos(12,11)),type([untyped],0),pos(45,11)),type([untyped],0),pos(8,11)),(1,11)),fact(equal(plus(identifier('File_',type(['File_'],1),pos(5,8)),identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['File_', 'Dir_'],1),pos(13,14)),identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),type([untyped],0),pos(19,14)),(1,14)),fact(in(identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),join(identifier('Root_',type(['Root_'],1),pos(9,17)),closure(identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['univ->univ_'],2),pos(25,20)),type(['univ_'],1),pos(24,20)),type([untyped],0),pos(17,20)),(1,20))]),assertions([fact(no(['d_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(24,23)),type(['Dir_'],1),pos(21,23))],in(identifier('d_',type(['Dir_'],1),pos(21,23)),join(identifier('d_',type(['Dir_'],1),pos(21,23)),closure1(identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['Dir->this_''FSObject_'],2),pos(37,23)),type(['FSObject_'],1),pos(36,23)),type([untyped],0),pos(32,23)),type([untyped],0),pos(18,23)),(1,23)),fact(one(['d_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(25,29)),type(['Dir_'],1),pos(22,29))],no(join(identifier('d_',type(['Dir_'],1),pos(22,29)),identifier('parent_',type(['FSObject->this_''Dir_'],2),pos(16,2)),type(['Dir_'],1),pos(35,29)),type([untyped],0),pos(31,29)),type([untyped],0),pos(18,29)),(1,29)),fact(all(['o_'],[field('o_',oneof(identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),type(['FSObject_'],1),pos(29,35)),type(['FSObject_'],1),pos(26,35))],lone(['d_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(48,35)),type(['Dir_'],1),pos(45,35))],in(identifier('o_',type(['FSObject_'],1),pos(26,35)),join(identifier('d_',type(['Dir_'],1),pos(45,35)),identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['FSObject_'],1),pos(60,35)),type([untyped],0),pos(56,35)),type([untyped],0),pos(40,35)),type([untyped],0),pos(22,35)),(1,35))]),commands([check(and([all(['d_', 'o_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(15,11)),type(['Dir_'],1),pos(12,11)), field('o_',oneof(join(identifier('d_',type(['Dir_'],1),pos(12,11)),identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['FSObject_'],1),pos(24,11)),type(['FSObject_'],1),pos(23,11)),type(['FSObject_'],1),pos(20,11))],equal(join(identifier('o_',type(['FSObject_'],1),pos(20,11)),identifier('parent_',type(['FSObject->this_''Dir_'],2),pos(16,2)),type(['Dir_'],1),pos(37,11)),identifier('d_',type(['Dir_'],1),pos(12,11)),type([untyped],0),pos(45,11)),type([untyped],0),pos(8,11)), equal(plus(identifier('File_',type(['File_'],1),pos(5,8)),identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['File_', 'Dir_'],1),pos(13,14)),identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),type([untyped],0),pos(19,14)), in(identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),join(identifier('Root_',type(['Root_'],1),pos(9,17)),closure(identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['univ->univ_'],2),pos(25,20)),type(['univ_'],1),pos(24,20)),type([untyped],0),pos(17,20)), not(no(['d_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(24,23)),type(['Dir_'],1),pos(21,23))],in(identifier('d_',type(['Dir_'],1),pos(21,23)),join(identifier('d_',type(['Dir_'],1),pos(21,23)),closure1(identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['Dir->this_''FSObject_'],2),pos(37,23)),type(['FSObject_'],1),pos(36,23)),type([untyped],0),pos(32,23)),type([untyped],0),pos(18,23)),type([untyped],0),pos(1,23))],pos(1,11)),global_scope(5),exact_scopes([]),bitwidth(-1),pos(1,26)),check(and([all(['d_', 'o_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(15,11)),type(['Dir_'],1),pos(12,11)), field('o_',oneof(join(identifier('d_',type(['Dir_'],1),pos(12,11)),identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['FSObject_'],1),pos(24,11)),type(['FSObject_'],1),pos(23,11)),type(['FSObject_'],1),pos(20,11))],equal(join(identifier('o_',type(['FSObject_'],1),pos(20,11)),identifier('parent_',type(['FSObject->this_''Dir_'],2),pos(16,2)),type(['Dir_'],1),pos(37,11)),identifier('d_',type(['Dir_'],1),pos(12,11)),type([untyped],0),pos(45,11)),type([untyped],0),pos(8,11)), equal(plus(identifier('File_',type(['File_'],1),pos(5,8)),identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['File_', 'Dir_'],1),pos(13,14)),identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),type([untyped],0),pos(19,14)), in(identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),join(identifier('Root_',type(['Root_'],1),pos(9,17)),closure(identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['univ->univ_'],2),pos(25,20)),type(['univ_'],1),pos(24,20)),type([untyped],0),pos(17,20)), not(one(['d_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(25,29)),type(['Dir_'],1),pos(22,29))],no(join(identifier('d_',type(['Dir_'],1),pos(22,29)),identifier('parent_',type(['FSObject->this_''Dir_'],2),pos(16,2)),type(['Dir_'],1),pos(35,29)),type([untyped],0),pos(31,29)),type([untyped],0),pos(18,29)),type([untyped],0),pos(1,29))],pos(1,11)),global_scope(5),exact_scopes([]),bitwidth(-1),pos(1,32)),check(and([all(['d_', 'o_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(15,11)),type(['Dir_'],1),pos(12,11)), field('o_',oneof(join(identifier('d_',type(['Dir_'],1),pos(12,11)),identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['FSObject_'],1),pos(24,11)),type(['FSObject_'],1),pos(23,11)),type(['FSObject_'],1),pos(20,11))],equal(join(identifier('o_',type(['FSObject_'],1),pos(20,11)),identifier('parent_',type(['FSObject->this_''Dir_'],2),pos(16,2)),type(['Dir_'],1),pos(37,11)),identifier('d_',type(['Dir_'],1),pos(12,11)),type([untyped],0),pos(45,11)),type([untyped],0),pos(8,11)), equal(plus(identifier('File_',type(['File_'],1),pos(5,8)),identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['File_', 'Dir_'],1),pos(13,14)),identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),type([untyped],0),pos(19,14)), in(identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),join(identifier('Root_',type(['Root_'],1),pos(9,17)),closure(identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['univ->univ_'],2),pos(25,20)),type(['univ_'],1),pos(24,20)),type([untyped],0),pos(17,20)), not(all(['o_'],[field('o_',oneof(identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),type(['FSObject_'],1),pos(29,35)),type(['FSObject_'],1),pos(26,35))],lone(['d_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(48,35)),type(['Dir_'],1),pos(45,35))],in(identifier('o_',type(['FSObject_'],1),pos(26,35)),join(identifier('d_',type(['Dir_'],1),pos(45,35)),identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['FSObject_'],1),pos(60,35)),type([untyped],0),pos(56,35)),type([untyped],0),pos(40,35)),type([untyped],0),pos(22,35)),type([untyped],0),pos(1,35))],pos(1,11)),global_scope(5),exact_scopes([]),bitwidth(-1),pos(1,38))]),functions([]),signatures([signature('FSObject_',[field('parent_',loneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(24,2)),type(['Dir_'],1),pos(16,2))],[],[],pos(5,2)),signature('Dir_',[field('contents_',setof(identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),type(['FSObject_'],1),pos(38,5)),type(['FSObject_'],1),pos(28,5))],[],[subsig('FSObject_')],pos(5,5)),signature('File_',[],[],[subsig('FSObject_')],pos(5,8)),signature('Root_',[],[no(join(identifier('Root_',type(['Root_'],1),pos(9,17)),identifier('parent_',type(['FSObject->this_''Dir_'],2),pos(16,2)),type(['Dir_'],1),pos(35,17)),type([untyped],0),pos(32,17))],[one, subsig('Dir_')],pos(9,17))])),Translated) , ! , 
    Translated == machine(generated(none,abstract_machine(none,machine(none),machine_header(none,alloytranslation,[]),[properties(none,[subset(none,identifier(none,'FSObject_'),image(none,closure(none,identifier(none,contents_)),identifier(none,'Root_'))),equal(none,union(none,identifier(none,'File_'),identifier(none,'Dir_')),identifier(none,'FSObject_')),forall(none,[identifier(none,d_),identifier(none,o_)],implication(none,conjunct(none,conjunct(none,member(none,identifier(none,o_),image(none,identifier(none,contents_),identifier(none,d_))),equal(none,card(none,identifier(none,o_)),integer(none,1))),conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1)))),equal(none,image(none,identifier(none,parent_),identifier(none,o_)),identifier(none,d_)))),forall(none,[identifier(none,o_)],implication(none,conjunct(none,member(none,identifier(none,o_),identifier(none,'FSObject_')),equal(none,card(none,identifier(none,o_)),integer(none,1))),less_equal(none,card(none,comprehension_set(none,[identifier(none,d_)],conjunct(none,conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1))),subset(none,identifier(none,o_),image(none,identifier(none,contents_),identifier(none,d_)))))),integer(none,1)))),equals(none,card(none,comprehension_set(none,[identifier(none,d_)],conjunct(none,conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1))),no(none,image(none,identifier(none,parent_),identifier(none,d_)))))),integer(none,1)),not(exists(none,[identifier(none,d_)],conjunct(none,conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1))),subset(none,identifier(none,d_),image(none,closure1(none,identifier(none,contents_)),identifier(none,d_)))))),no(none,image(none,identifier(none,parent_),identifier(none,'Root_'))),member(identifier(none,'Root_'),identifier(none,'Dir_')),member(identifier(none,'File_'),identifier(none,'FSObject_')),member(none,identifier(none,contents_),identifier(none,'FSObject_')),member(identifier(none,'Dir_'),identifier(none,'FSObject_')),conjunct(none,member(none,identifier(none,parent_),identifier(none,'Dir_')),less_equal(none,card(none,identifier(none,parent_)),integer(none,1)))]),operations(none,[operation(none,identifier(none,empty),[],[],precondition(none,conjunct(none,conjunct(none,truth(none),b(truth,pred,[])),conjunct(none,not(none,forall(none,[identifier(none,o_)],implication(none,conjunct(none,member(none,identifier(none,o_),identifier(none,'FSObject_')),equal(none,card(none,identifier(none,o_)),integer(none,1))),less_equal(none,card(none,comprehension_set(none,[identifier(none,d_)],conjunct(none,conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1))),subset(none,identifier(none,o_),image(none,identifier(none,contents_),identifier(none,d_)))))),integer(none,1))))),conjunct(none,subset(none,identifier(none,'FSObject_'),image(none,closure(none,identifier(none,contents_)),identifier(none,'Root_'))),conjunct(none,equal(none,union(none,identifier(none,'File_'),identifier(none,'Dir_')),identifier(none,'FSObject_')),forall(none,[identifier(none,d_),identifier(none,o_)],implication(none,conjunct(none,conjunct(none,member(none,identifier(none,o_),image(none,identifier(none,contents_),identifier(none,d_))),equal(none,card(none,identifier(none,o_)),integer(none,1))),conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1)))),equal(none,image(none,identifier(none,parent_),identifier(none,o_)),identifier(none,d_)))))))),skip(none))),operation(none,identifier(none,empty),[],[],precondition(none,conjunct(none,conjunct(none,truth(none),b(truth,pred,[])),conjunct(none,not(none,equals(none,card(none,comprehension_set(none,[identifier(none,d_)],conjunct(none,conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1))),no(none,image(none,identifier(none,parent_),identifier(none,d_)))))),integer(none,1))),conjunct(none,subset(none,identifier(none,'FSObject_'),image(none,closure(none,identifier(none,contents_)),identifier(none,'Root_'))),conjunct(none,equal(none,union(none,identifier(none,'File_'),identifier(none,'Dir_')),identifier(none,'FSObject_')),forall(none,[identifier(none,d_),identifier(none,o_)],implication(none,conjunct(none,conjunct(none,member(none,identifier(none,o_),image(none,identifier(none,contents_),identifier(none,d_))),equal(none,card(none,identifier(none,o_)),integer(none,1))),conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1)))),equal(none,image(none,identifier(none,parent_),identifier(none,o_)),identifier(none,d_)))))))),skip(none))),operation(none,identifier(none,empty),[],[],precondition(none,conjunct(none,conjunct(none,truth(none),b(truth,pred,[])),conjunct(none,not(none,not(exists(none,[identifier(none,d_)],conjunct(none,conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1))),subset(none,identifier(none,d_),image(none,closure1(none,identifier(none,contents_)),identifier(none,d_))))))),conjunct(none,subset(none,identifier(none,'FSObject_'),image(none,closure(none,identifier(none,contents_)),identifier(none,'Root_'))),conjunct(none,equal(none,union(none,identifier(none,'File_'),identifier(none,'Dir_')),identifier(none,'FSObject_')),forall(none,[identifier(none,d_),identifier(none,o_)],implication(none,conjunct(none,conjunct(none,member(none,identifier(none,o_),image(none,identifier(none,contents_),identifier(none,d_))),equal(none,card(none,identifier(none,o_)),integer(none,1))),conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1)))),equal(none,image(none,identifier(none,parent_),identifier(none,o_)),identifier(none,d_)))))))),skip(none)))]),constants(none,[identifier(none,'Root_'),identifier(none,'File_'),identifier(none,'Dir_')]),sets(none,[deferred_set(none,identifier(none,'FSObject_'))])]))).

test(river_crossing,[]) :- 
    translate_model(alloy_model(facts([fact(equal(identifier('eats_',type(['Object->this_''Object_'],2),pos(23,5)),plus(cartesian(identifier('Fox_',type(['Fox_'],1),pos(17,6)),identifier('Chicken_',type(['Chicken_'],1),pos(22,6)),type(['Fox->this_''Chicken_'],2),pos(18,9)),cartesian(identifier('Chicken_',type(['Chicken_'],1),pos(22,6)),identifier('Grain_',type(['Grain_'],1),pos(31,6)),type(['Chicken->this_''Grain_'],2),pos(37,9)),type(['Fox->this_''Chicken_', 'Chicken->this_''Grain_'],2),pos(28,9)),type([untyped],0),pos(13,9)),(1,9)),fact(and([equal(join(fun_call('ordering_''first_',[],type(['State_'],1),pos(8,15)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(13,15)),identifier('Object_',type(['Object_'],1),pos(14,5)),type([untyped],0),pos(19,15)), no(join(fun_call('ordering_''first_',[],type(['State_'],1),pos(34,15)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(39,15)),type([untyped],0),pos(31,15))],pos(28,15)),(1,15)),fact(all(['s_', 's__'],[field('s_',oneof(identifier('State_',type(['State_'],1),pos(5,12)),type(['State_'],1),pos(10,27)),type(['State_'],1),pos(7,27)), field('s__',oneof(join(identifier('s_',type(['State_'],1),pos(7,27)),fun_call('ordering_''next_',[],type(['State->this_''State_'],2),pos(23,27)),type(['State_'],1),pos(22,27)),type(['State_'],1),pos(21,27)),type(['State_'],1),pos(17,27))],if_then_else(in(identifier('Farmer_',type(['Farmer_'],1),pos(9,6)),join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(16,28)),type([untyped],0),pos(12,28)),pred_call('crossRiver_',[join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(20,29)), join(identifier('s__',type(['State_'],1),pos(17,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(29,29)), join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(37,29)), join(identifier('s__',type(['State_'],1),pos(17,27)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(45,29))],type([untyped],0),pos(7,29)),pred_call('crossRiver_',[join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(20,31)), join(identifier('s__',type(['State_'],1),pos(17,27)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(28,31)), join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(35,31)), join(identifier('s__',type(['State_'],1),pos(17,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(44,31))],type([untyped],0),pos(7,31)),type([untyped],0),pos(22,28)),type([untyped],0),pos(3,27)),(1,26))]),assertions([]),commands([run(and([equal(identifier('eats_',type(['Object->this_''Object_'],2),pos(23,5)),plus(cartesian(identifier('Fox_',type(['Fox_'],1),pos(17,6)),identifier('Chicken_',type(['Chicken_'],1),pos(22,6)),type(['Fox->this_''Chicken_'],2),pos(18,9)),cartesian(identifier('Chicken_',type(['Chicken_'],1),pos(22,6)),identifier('Grain_',type(['Grain_'],1),pos(31,6)),type(['Chicken->this_''Grain_'],2),pos(37,9)),type(['Fox->this_''Chicken_', 'Chicken->this_''Grain_'],2),pos(28,9)),type([untyped],0),pos(13,9)), equal(join(fun_call('ordering_''first_',[],type(['State_'],1),pos(8,15)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(13,15)),identifier('Object_',type(['Object_'],1),pos(14,5)),type([untyped],0),pos(19,15)), no(join(fun_call('ordering_''first_',[],type(['State_'],1),pos(34,15)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(39,15)),type([untyped],0),pos(31,15)), all(['s_', 's__'],[field('s_',oneof(identifier('State_',type(['State_'],1),pos(5,12)),type(['State_'],1),pos(10,27)),type(['State_'],1),pos(7,27)), field('s__',oneof(join(identifier('s_',type(['State_'],1),pos(7,27)),fun_call('ordering_''next_',[],type(['State->this_''State_'],2),pos(23,27)),type(['State_'],1),pos(22,27)),type(['State_'],1),pos(21,27)),type(['State_'],1),pos(17,27))],if_then_else(in(identifier('Farmer_',type(['Farmer_'],1),pos(9,6)),join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(16,28)),type([untyped],0),pos(12,28)),pred_call('crossRiver_',[join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(20,29)), join(identifier('s__',type(['State_'],1),pos(17,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(29,29)), join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(37,29)), join(identifier('s__',type(['State_'],1),pos(17,27)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(45,29))],type([untyped],0),pos(7,29)),pred_call('crossRiver_',[join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(20,31)), join(identifier('s__',type(['State_'],1),pos(17,27)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(28,31)), join(identifier('s_',type(['State_'],1),pos(7,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(35,31)), join(identifier('s__',type(['State_'],1),pos(17,27)),identifier('near_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(44,31))],type([untyped],0),pos(7,31)),type([untyped],0),pos(22,28)),type([untyped],0),pos(3,27)), equal(join(fun_call('ordering_''last_',[],type(['State_'],1),pos(7,36)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(11,36)),identifier('Object_',type(['Object_'],1),pos(14,5)),type([untyped],0),pos(15,36))],pos(1,9)),global_scope(-1),exact_scopes([('State_',8)]),bitwidth(-1),pos(1,36))]),functions([predicate('crossRiver_',[identifier('from_',type(['Object_'],1),pos(18,18)), identifier('from__',type(['Object_'],1),pos(24,18)), identifier('to_',type(['Object_'],1),pos(31,18)), identifier('to__',type(['Object_'],1),pos(35,18))],[field('from_',setof(identifier('Object_',type(['Object_'],1),pos(14,5)),type(['Object_'],1),pos(40,18)),type(['Object_'],1),pos(18,18))],one(['x_'],[field('x_',oneof(identifier('from_',type(['Object_'],1),pos(18,18)),type(['Object_'],1),pos(10,19)),type(['Object_'],1),pos(7,19))],and([equal(identifier('from__',type(['Object_'],1),pos(24,18)),minus(minus(minus(identifier('from_',type(['Object_'],1),pos(18,18)),identifier('x_',type(['Object_'],1),pos(7,19)),type(['Object_'],1),pos(18,20)),identifier('Farmer_',type(['Farmer_'],1),pos(9,6)),type(['Object_'],1),pos(22,20)),join(identifier('from__',type(['Object_'],1),pos(24,18)),identifier('eats_',type(['Object->this_''Object_'],2),pos(23,5)),type(['Object_'],1),pos(38,20)),type(['Object_'],1),pos(31,20)),type([untyped],0),pos(11,20)), equal(identifier('to__',type(['Object_'],1),pos(35,18)),plus(plus(identifier('to_',type(['Object_'],1),pos(31,18)),identifier('x_',type(['Object_'],1),pos(7,19)),type(['Object_'],1),pos(14,21)),identifier('Farmer_',type(['Farmer_'],1),pos(9,6)),type(['Object_'],1),pos(18,21)),type([untyped],0),pos(9,21))],pos(1,1)),type([untyped],0),pos(3,19)),pos(1,18)),predicate('run$1_',[],[],equal(join(fun_call('ordering_''last_',[],type(['State_'],1),pos(7,36)),identifier('far_',type(['State->this_''Object_'],2),pos(13,12)),type(['Object_'],1),pos(11,36)),identifier('Object_',type(['Object_'],1),pos(14,5)),type([untyped],0),pos(15,36)),pos(1,36))]),signatures([signature('Object_',[field('eats_',setof(identifier('Object_',type(['Object_'],1),pos(14,5)),type(['Object_'],1),pos(29,5)),type(['Object_'],1),pos(23,5))],[],[abstract],pos(14,5)),signature('Farmer_',[],[],[one, subsig('Object_')],pos(9,6)),signature('Fox_',[],[],[one, subsig('Object_')],pos(17,6)),signature('Chicken_',[],[],[one, subsig('Object_')],pos(22,6)),signature('Grain_',[],[],[one, subsig('Object_')],pos(31,6)),signature('State_',[field('near_',setof(identifier('Object_',type(['Object_'],1),pos(14,5)),type(['Object_'],1),pos(24,12)),type(['Object_'],1),pos(13,12))],[],[ordered],pos(5,12))])),Translated) , ! , 
    Translated == machine(generated(none,abstract_machine(none,machine(none),machine_header(none,alloytranslation,[]),[properties(none,[forall(none,[identifier(none,s_),identifier(none,s__)],implication(none,conjunct(none,conjunct(none,member(none,identifier(none,s__),image(none,definition('ordering_\'next_',[],type(['State->this_\'State_'],2),pos(23,27)),identifier(none,s_))),equal(none,card(none,identifier(none,s__)),integer(none,1))),conjunct(none,member(none,identifier(none,s_),identifier(none,'State_')),equal(none,card(none,identifier(none,s_)),integer(none,1)))),if_then_else(none,subset(none,identifier(none,'Farmer_'),image(none,identifier(none,near_),identifier(none,s_))),definition(crossRiver_,[image(none,identifier(none,near_),identifier(none,s_)),image(none,identifier(none,near_),identifier(none,s__)),image(none,identifier(none,far_),identifier(none,s_)),image(none,identifier(none,far_),identifier(none,s__))],type([untyped],0),pos(7,29))))),conjunct(none,no(none,image(none,identifier(none,far_),definition('ordering_\'first_',[],type(['State_'],1),pos(34,15)))),equal(none,image(none,identifier(none,near_),definition('ordering_\'first_',[],type(['State_'],1),pos(8,15))),identifier(none,'Object_'))),equal(none,identifier(none,eats_),union(none,cartesian(none,identifier(none,'Fox_'),identifier(none,'Chicken_')),cartesian(none,identifier(none,'Chicken_'),identifier(none,'Grain_')))),member(none,identifier(none,near_),identifier(none,'Object_')),member(identifier(none,'Grain_'),identifier(none,'Object_')),member(identifier(none,'Chicken_'),identifier(none,'Object_')),member(identifier(none,'Fox_'),identifier(none,'Object_')),member(identifier(none,'Farmer_'),identifier(none,'Object_')),member(none,identifier(none,eats_),identifier(none,'Object_'))]),definitions(none,[predicate_definition(none,'run$1_',[],equal(none,image(none,identifier(none,far_),definition('ordering_\'last_',[],type(['State_'],1),pos(7,36))),identifier(none,'Object_'))),predicate_definition(none,crossRiver_,[identifier(none,from_),identifier(none,from__),identifier(none,to_),identifier(none,to__)],conjunct(none,equals(none,card(none,comprehension_set(none,[identifier(none,x_)],conjunct(none,conjunct(none,member(none,identifier(none,x_),identifier(none,from_)),equal(none,card(none,identifier(none,x_)),integer(none,1))),conjunct(none,equal(none,identifier(none,to__),union(none,union(none,identifier(none,to_),identifier(none,x_)),identifier(none,'Farmer_'))),equal(none,identifier(none,from__),set_subtraction(none,set_subtraction(none,set_subtraction(none,identifier(none,from_),identifier(none,x_)),identifier(none,'Farmer_')),image(none,identifier(none,eats_),identifier(none,from__)))))))),integer(none,1)),member(none,identifier(none,from_),identifier(none,'Object_'))))]),operations(none,[operation(none,identifier(none,empty),[],[],precondition(none,conjunct(none,conjunct(none,equal(none,card(none,identifier(none,'State_')),integer(none,8)),truth(none)),conjunct(none,equal(none,image(none,identifier(none,far_),definition('ordering_\'last_',[],type(['State_'],1),pos(7,36))),identifier(none,'Object_')),conjunct(none,forall(none,[identifier(none,s_),identifier(none,s__)],implication(none,conjunct(none,conjunct(none,member(none,identifier(none,s__),image(none,definition('ordering_\'next_',[],type(['State->this_\'State_'],2),pos(23,27)),identifier(none,s_))),equal(none,card(none,identifier(none,s__)),integer(none,1))),conjunct(none,member(none,identifier(none,s_),identifier(none,'State_')),equal(none,card(none,identifier(none,s_)),integer(none,1)))),if_then_else(none,subset(none,identifier(none,'Farmer_'),image(none,identifier(none,near_),identifier(none,s_))),definition(crossRiver_,[image(none,identifier(none,near_),identifier(none,s_)),image(none,identifier(none,near_),identifier(none,s__)),image(none,identifier(none,far_),identifier(none,s_)),image(none,identifier(none,far_),identifier(none,s__))],type([untyped],0),pos(7,29))))),conjunct(none,no(none,image(none,identifier(none,far_),definition('ordering_\'first_',[],type(['State_'],1),pos(34,15)))),conjunct(none,equal(none,image(none,identifier(none,near_),definition('ordering_\'first_',[],type(['State_'],1),pos(8,15))),identifier(none,'Object_')),equal(none,identifier(none,eats_),union(none,cartesian(none,identifier(none,'Fox_'),identifier(none,'Chicken_')),cartesian(none,identifier(none,'Chicken_'),identifier(none,'Grain_'))))))))),skip(none)))]),sets(none,[deferred_set(none,identifier(none,'State_')),deferred_set(none,identifier(none,'Object_'))]),constants(none,[identifier(none,'Grain_'),identifier(none,'Chicken_'),identifier(none,'Fox_'),identifier(none,'Farmer_')])]))).

:- end_tests(full_machine_translation).

:- begin_tests(single_expr_translation).

% fields
test(field_set_of,[]) :- 
    alloy2b:translate_field_aux(field('hand_',setof(identifier('Card_',type(['Card_'],1),pos(5,1)),type(['Card_'],1),pos(26,3)),type(['Card_'],1),pos(20,3)),Translated) , ! , 
    Translated == member(none,identifier(none,hand_),identifier(none,'Card_')).

test(field_one_of,[]) :- 
    alloy2b:translate_field_aux(field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(15,11)),type(['Dir_'],1),pos(12,11)),Translated) , ! , 
    Translated == conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1))).

test(field_some_of,[]) :- 
    alloy2b:translate_field_aux(field('parent_',someof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(24,2)),type(['Dir_'],1),pos(16,2)),Translated) , ! , 
    Translated == conjunct(none,member(none,identifier(none,parent_),identifier(none,'Dir_')),greater(none,card(none,identifier(none,parent_)),integer(none,0))).

test(field_lone_of,[]) :- 
    alloy2b:translate_field_aux(field('parent_',loneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(24,2)),type(['Dir_'],1),pos(16,2)),Translated) , ! , 
    Translated == conjunct(none,member(none,identifier(none,parent_),identifier(none,'Dir_')),less_equal(none,card(none,identifier(none,parent_)),integer(none,1))).

% and
test(expr_and,[]) :- 
    alloy2b:translate_e_p(and([all(['d_', 'o_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(15,11)),type(['Dir_'],1),pos(12,11)), field('o_',oneof(join(identifier('d_',type(['Dir_'],1),pos(12,11)),identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['FSObject_'],1),pos(24,11)),type(['FSObject_'],1),pos(23,11)),type(['FSObject_'],1),pos(20,11))],equal(join(identifier('o_',type(['FSObject_'],1),pos(20,11)),identifier('parent_',type(['FSObject->this_''Dir_'],2),pos(16,2)),type(['Dir_'],1),pos(37,11)),identifier('d_',type(['Dir_'],1),pos(12,11)),type(untyped),pos(45,11)),type(untyped),pos(8,11)), equal(plus(identifier('File_',type(['File_'],1),pos(5,8)),identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['File_','Dir_'],1),pos(13,14)),identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),type(untyped),pos(19,14)), in(identifier('FSObject_',type(['FSObject_'],1),pos(5,2)),join(identifier('Root_',type(['Root_'],1),pos(9,17)),closure(identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['univ->univ_'],2),pos(25,20)),type(['univ_'],1),pos(24,20)),type(untyped),pos(17,20)), not(no(['d_'],[field('d_',oneof(identifier('Dir_',type(['Dir_'],1),pos(5,5)),type(['Dir_'],1),pos(24,23)),type(['Dir_'],1),pos(21,23))],in(identifier('d_',type(['Dir_'],1),pos(21,23)),join(identifier('d_',type(['Dir_'],1),pos(21,23)),closure1(identifier('contents_',type(['Dir->this_''FSObject_'],2),pos(28,5)),type(['Dir->this_''FSObject_'],2),pos(37,23)),type(['FSObject_'],1),pos(36,23)),type(untyped),pos(32,23)),type(untyped),pos(18,23)),type(untyped),pos(1,23))],pos(1,11)),Translated) , ! , 
    Translated == conjunct(none,not(none,not(exists(none,[identifier(none,d_)],conjunct(none,conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1))),subset(none,identifier(none,d_),image(none,closure1(none,identifier(none,contents_)),identifier(none,d_))))))),conjunct(none,subset(none,identifier(none,'FSObject_'),image(none,closure(none,identifier(none,contents_)),identifier(none,'Root_'))),conjunct(none,equal(none,union(none,identifier(none,'File_'),identifier(none,'Dir_')),identifier(none,'FSObject_')),forall(none,[identifier(none,d_),identifier(none,o_)],implication(none,conjunct(none,conjunct(none,member(none,identifier(none,o_),image(none,identifier(none,contents_),identifier(none,d_))),equal(none,card(none,identifier(none,o_)),integer(none,1))),conjunct(none,member(none,identifier(none,d_),identifier(none,'Dir_')),equal(none,card(none,identifier(none,d_)),integer(none,1)))),equal(none,image(none,identifier(none,parent_),identifier(none,o_)),identifier(none,d_))))))).

:- end_tests(single_expr_translation).
